<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å²èœå§†</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #f0f0f0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: Arial, sans-serif;
        }
        
        .board {
            display: inline-block;
            padding: 20px;
            background-color: #333;
            border-radius: 10px;
        }
        
        body {
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        .container {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            position: relative;
        }
        
        .board {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 20px;
            background-color: #333;
            border-radius: 10px;
            cursor: grab;
            user-select: none;
        }
        
        .board:active {
            cursor: grabbing;
        }
        
        /* ç²¾ç¡®çš„æ­£å…­è¾¹å½¢ç½‘æ ¼ */
        .hex {
            width: 70px;
            height: 60.62px;
            background-color: #4a90e2;
            margin: 0;
            position: relative;
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .row {
            display: flex;
            justify-content: center;
            margin-bottom: -15.16px;
        }
        
        .row.offset {
            margin-left: 70px;
        }
        
        .hex:hover {
            background-color: #5aa0f2;
            transform: scale(1.05);
        }
        
        .hex::before {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            right: 2px;
            bottom: 2px;
            background-color: rgba(255, 255, 255, 0.1);
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
        }
        
        /* æ£‹å­æ ·å¼ */
        .hex .piece {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            background-color: currentColor;
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }
        
        /* ä¸åˆæ³•å¯ç§»åŠ¨æ ¼å­æ ·å¼ */
        .hex.movable.invalid::before {
            background-color: rgba(128, 128, 128, 0.5);
        }
        
        .hex.movable.invalid:hover::before {
            background-color: rgba(128, 128, 128, 0.7);
        }
        
        /* ç©å®¶1æ¨¡æ¿æ£‹å­ï¼ˆçº¢è‰²ï¼‰ */
        .hex .piece.player1.template {
            background-color: #e74c3c;
        }
        
        /* ç©å®¶1ç›®æ ‡æ£‹å­ï¼ˆçº¢è‰²å¸¦æ——å­ï¼‰ */
        .hex .piece.player1.target {
            background-color: #e74c3c;
        }
        
        /* ç©å®¶1æ–¹æ–¹æ£‹å­ï¼ˆçº¢è‰²å¸¦æ–¹å—ï¼‰ */
        .hex .piece.player1.square {
            background-color: #e74c3c;
        }
        
        /* ç©å®¶1åœ†åœ†æ£‹å­ï¼ˆçº¢è‰²å¸¦é»‘ç™½åœ†åœˆï¼‰ */
        .hex .piece.player1.circle {
            background-color: #e74c3c;
        }
        
        /* ç©å®¶2æ¨¡æ¿æ£‹å­ï¼ˆé»„è‰²ï¼‰ */
        .hex .piece.player2.template {
            background-color: #f1c40f;
        }
        
        /* ç©å®¶2ç›®æ ‡æ£‹å­ï¼ˆé»„è‰²å¸¦æ——å­ï¼‰ */
        .hex .piece.player2.target {
            background-color: #f1c40f;
        }
        
        /* ç©å®¶2æ–¹æ–¹æ£‹å­ï¼ˆé»„è‰²å¸¦æ–¹å—ï¼‰ */
        .hex .piece.player2.square {
            background-color: #f1c40f;
        }
        
        /* ç©å®¶2åœ†åœ†æ£‹å­ï¼ˆé»„è‰²å¸¦é»‘ç™½åœ†åœˆï¼‰ */
        .hex .piece.player2.circle {
            background-color: #f1c40f;
        }
        
        /* ç©å®¶1è·³è·³æ£‹å­ï¼ˆçº¢è‰²å¸¦é»‘ç™½ç®­å¤´ï¼‰ */
        .hex .piece.player1.jump {
            background-color: #e74c3c;
        }
        
        /* ç©å®¶2è·³è·³æ£‹å­ï¼ˆé»„è‰²å¸¦é»‘ç™½ç®­å¤´ï¼‰ */
        .hex .piece.player2.jump {
            background-color: #f1c40f;
        }
        
        /* ç©å®¶1å‹å‹æ£‹å­ï¼ˆçº¢è‰²å¸¦äº”è§’æ˜Ÿï¼‰ */
        .hex .piece.player1.press {
            background-color: #e74c3c;
        }
        
        /* ç©å®¶2å‹å‹æ£‹å­ï¼ˆé»„è‰²å¸¦äº”è§’æ˜Ÿï¼‰ */
        .hex .piece.player2.press {
            background-color: #f1c40f;
        }
        
        /* æ——å­å›¾æ ‡ */
        .piece.target::after {
            content: "ğŸ";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            font-weight: bold;
            pointer-events: none;
            z-index: 5;
        }
        
        /* æ–¹æ–¹æ£‹å­å›¾æ ‡ - é»‘ç™½ç›¸é—´çš„æ–¹å— */
        .piece.square::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            background: linear-gradient(45deg, #000 25%, #fff 25%, #fff 50%, #000 50%, #000 75%, #fff 75%);
            background-size: 6px 6px;
            pointer-events: none;
            z-index: 5;
        }
        
        /* åœ†åœ†æ£‹å­å›¾æ ‡ - é»‘ç™½ç›¸é—´çš„åœ†å½¢ */
        .piece.circle::after {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 14px;
            height: 14px;
            border-radius: 50%;
            background: radial-gradient(circle at center, #000 30%, #fff 30%, #fff 50%, #000 50%, #000 70%, #fff 70%);
            background-size: 7px 7px;
            pointer-events: none;
            z-index: 5;
        }
        
        /* è·³è·³æ£‹å­å›¾æ ‡ - é»‘ç™½ç›¸é—´çš„ç®­å¤´ */
        .piece.jump::after {
            content: "â®";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 16px;
            font-weight: bold;
            pointer-events: none;
            z-index: 5;
            background: linear-gradient(45deg, #000 25%, #fff 25%, #fff 50%, #000 50%, #000 75%, #fff 75%);
            background-size: 6px 6px;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* å‹å‹æ£‹å­å›¾æ ‡ - é»‘ç™½ç›¸é—´çš„äº”è§’æ˜Ÿ */
        .piece.press::after {
            content: "â­";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 20px;
            font-weight: bold;
            pointer-events: none;
            z-index: 5;
            background: linear-gradient(45deg, #000 25%, #fff 25%, #fff 50%, #000 50%, #000 75%, #fff 75%);
            background-size: 6px 6px;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        /* é€‰ä¸­æ£‹å­æ ·å¼ */
        .hex.selected .piece {
            box-shadow: 0 0 10px 3px rgba(255, 255, 0, 0.8);
            z-index: 10;
        }
        
        /* å¯ç§»åŠ¨æ ¼å­æ ·å¼ */
        .hex.movable {
            cursor: pointer;
            position: relative;
        }
        
        /* å¯ç§»åŠ¨æ ¼å­è¦†ç›–å±‚ */
        .hex.movable::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 255, 0, 0.5);
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            z-index: 6; /* é«˜äºæ£‹å­çš„z-indexå€¼5 */
            pointer-events: none;
        }
        
        .hex.movable:hover::before {
            background-color: rgba(0, 255, 0, 0.7);
        }
        
        /* UIæ ·å¼ */
        .ui-left,
        .ui-right {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100px;
            background-color: rgba(51, 51, 51, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }
        
        .ui-left {
            left: 0;
            border-right: 2px solid #4a90e2;
        }
        
        .ui-right {
            right: 0;
            border-left: 2px solid #4a90e2;
        }
        
        /* æ£‹å­åº“æ ·å¼ */
        .piece-library {
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 10px;
            margin: 10px 0;
        }
        
        /* æ£‹å­æ•°é‡æ ·å¼ */
        .piece-count {
            font-size: 18px;
            font-weight: bold;
            color: white;
            min-width: 20px;
            text-align: center;
        }
        
        .piece-library .piece {
            width: 40px;
            height: 34.64px;
            clip-path: polygon(50% 0%, 100% 25%, 100% 75%, 50% 100%, 0% 75%, 0% 25%);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        /* æ£‹å­åº“æ£‹å­é¢œè‰² */
        .piece-library .piece.player1 {
            background-color: #e74c3c;
        }
        
        .piece-library .piece.player2 {
            background-color: #f1c40f;
        }
        
        /* å·²ç§»é™¤æ—§çš„æ£‹å­æ•°é‡æ˜¾ç¤ºï¼Œæ”¹ä¸ºä½¿ç”¨ç‹¬ç«‹çš„spanå…ƒç´  */
        
        /* å·²ä½¿ç”¨æ£‹å­æ ·å¼ */
        .piece-library .piece.used {
            opacity: 0.3;
        }
        
        /* æ£‹å­é€‰æ‹©å™¨æ ·å¼ */
        .piece-selector {
            cursor: pointer;
            padding: 5px;
            border-radius: 5px;
            transition: all 0.3s ease;
        }
        
        /* é€‰ä¸­çŠ¶æ€ */
        .piece-selector.selected {
            background-color: rgba(74, 144, 226, 0.5);
            border: 2px solid #4a90e2;
        }
        
        /* é¼ æ ‡æ‚¬åœæ•ˆæœ */
        .piece-selector:hover {
            background-color: rgba(74, 144, 226, 0.3);
        }
        
        /* æ¸¸æˆç»“æŸç•Œé¢æ ·å¼ */
        .game-over-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .game-over-content {
            text-align: center;
            color: white;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 30px 50px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        
        .game-over-content h1 {
            font-size: 48px;
            margin: 0 0 30px 0;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            animation: fadeIn 1s ease-out;
        }
        
        /* å†æ¥ä¸€æ¬¡æŒ‰é’®æ ·å¼ */
        .restart-button {
            background-color: #4a90e2;
            color: white;
            border: none;
            padding: 12px 24px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .restart-button:hover {
            background-color: #5aa0f2;
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        .restart-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* æ¸¸æˆç»“æŸåç¦ç”¨äº¤äº’ */
        .game-over .board,
        .game-over .ui-left,
        .game-over .ui-right {
            pointer-events: none;
        }
        
        /* ç¡®ä¿æ¸¸æˆç»“æŸè¦†ç›–å±‚å¯ä»¥äº¤äº’ */
        .game-over .game-over-overlay {
            pointer-events: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- å·¦ä¾§UIï¼šçº¢æ–¹æ£‹å­åº“ -->
        <div class="ui-left">
            <div class="piece-selector piece-library" id="player1TemplateLibrary" data-piece-type="template">
                <div class="piece player1 template"></div>
                <span class="piece-count"></span>
            </div>
            <div class="piece-selector piece-library" id="player1TargetLibrary" data-piece-type="target">
                <div class="piece player1 target"></div>
                <span class="piece-count"></span>
            </div>
            <div class="piece-selector piece-library" id="player1SquareLibrary" data-piece-type="square">
                <div class="piece player1 square"></div>
                <span class="piece-count"></span>
            </div>
            <div class="piece-selector piece-library" id="player1CircleLibrary" data-piece-type="circle">
                <div class="piece player1 circle"></div>
                <span class="piece-count"></span>
            </div>
            <div class="piece-selector piece-library" id="player1JumpLibrary" data-piece-type="jump">
                <div class="piece player1 jump"></div>
                <span class="piece-count"></span>
            </div>
            <div class="piece-selector piece-library" id="player1PressLibrary" data-piece-type="press">
                <div class="piece player1 press"></div>
                <span class="piece-count"></span>
            </div>
        </div>
        
        <!-- æ£‹ç›˜ -->
        <div class="board" id="hexBoard">
            <!-- å…­è¾¹å½¢æ£‹ç›˜å°†é€šè¿‡JavaScriptç”Ÿæˆ -->
        </div>
        
        <!-- å³ä¾§UIï¼šé»„æ–¹æ£‹å­åº“ -->
        <div class="ui-right">
            <div class="piece-selector piece-library" id="player2TemplateLibrary" data-piece-type="template">
                <div class="piece player2 template"></div>
                <span class="piece-count"></span>
            </div>
            <div class="piece-selector piece-library" id="player2TargetLibrary" data-piece-type="target">
                <div class="piece player2 target"></div>
                <span class="piece-count"></span>
            </div>
            <div class="piece-selector piece-library" id="player2SquareLibrary" data-piece-type="square">
                <div class="piece player2 square"></div>
                <span class="piece-count"></span>
            </div>
            <div class="piece-selector piece-library" id="player2CircleLibrary" data-piece-type="circle">
                <div class="piece player2 circle"></div>
                <span class="piece-count"></span>
            </div>
            <div class="piece-selector piece-library" id="player2JumpLibrary" data-piece-type="jump">
                <div class="piece player2 jump"></div>
                <span class="piece-count"></span>
            </div>
            <div class="piece-selector piece-library" id="player2PressLibrary" data-piece-type="press">
                <div class="piece player2 press"></div>
                <span class="piece-count"></span>
            </div>
        </div>
        
        <!-- æ¸¸æˆç»“æŸç•Œé¢ -->
        <div class="game-over-overlay" id="gameOverOverlay" style="display: none;">
            <div class="game-over-content">
                <h1 id="gameOverText"></h1>
                <button class="restart-button" onclick="restartGame()">å†æ¥ä¸€æ¬¡</button>
            </div>
        </div>
        
        <!-- æ•™ç¨‹æç¤ºç•Œé¢ -->
        <div class="game-over-overlay" id="tutorialOverlay" style="display: none;">
            <div class="game-over-content">
                <h1>å²èœå§†</h1>
                <p style="font-size: 18px; margin: 10px 0 20px 0; color: #ccc;">è™½ç„¶å·²ç»è¢«ç®€åŒ–åˆ°æ²¡æœ‰ä»»ä½•å²èœå§†å…ƒç´ äº†</p>
                <div style="display: flex; gap: 20px; margin-top: 20px; justify-content: center;">
                    <button class="restart-button" onclick="startTutorial()">æˆ‘æ˜¯æ–°æ‰‹</button>
                    <button class="restart-button" onclick="skipTutorial()">è·³è¿‡ç®€ä»‹</button>
                </div>
            </div>
        </div>
        
        <!-- æ–°æ‰‹æç¤ºç•Œé¢ -->
        <div class="game-over-overlay" id="newbieOverlay" style="display: none;">
            <div class="game-over-content">
                <p style="font-size: 18px; margin: 20px 0; color: white;">
                    æ¬¢è¿æ¥åˆ°å²èœå§†ï¼<br><br>
                    è¿™æ˜¯ä¸€ä¸ªå…­è¾¹å½¢æ£‹ç›˜ä¸Šçš„åŒäººæ¸¸æˆã€‚ç›®æ ‡æ˜¯ä½¿å¯¹æ–¹çš„ğŸè¢«å®Œå…¨åŒ…å›´ã€‚<br>
                    å·¦é”®æ‹–åŠ¨ç”»é¢ï¼Œå·¦é”®é€‰æ‹©æ£‹å­ç§ç±»å¹¶æ”¾ç½®ï¼Œå·¦é”®é€‰æ‹©æ£‹å­å¹¶ç§»åŠ¨ã€‚<br><br>
                    ä¸‹é¢æ˜¯æ£‹å­åŠŸèƒ½ä»‹ç»ï¼š<br>
                    ï¼ˆæ²¡æœ‰ç‰¹æ®Šå›¾æ ‡ï¼‰ï¼šæ²¡æœ‰ç‰¹å¼‚åŠŸèƒ½ã€‚<br>
                    ğŸï¼šä½œä¸ºåˆ¤å®šèƒœè´Ÿçš„æ¡ä»¶ã€‚åœ¨æœ€å¼€å§‹çš„ä¸‰å›åˆå†…å¿…é¡»è¢«æ”¾å‡ºã€‚<br>
                    <span style="display: inline-block; width: 12px; height: 12px; background: linear-gradient(45deg, #000 25%, #fff 25%, #fff 50%, #000 50%, #000 75%, #fff 75%); background-size: 6px 6px;"></span>ï¼šå¿…é¡»è¿ç»­ç§»åŠ¨ä¸‰æ ¼ã€‚å¯ä»¥èµ°å›å¤´è·¯ã€‚<br>
                    <span style="display: inline-block; width: 14px; height: 14px; border-radius: 50%; background: radial-gradient(circle at center, #000 30%, #fff 30%, #fff 50%, #000 50%, #000 70%, #fff 70%); background-size: 7px 7px;"></span>ï¼šå¯ä»¥è¿ç»­èµ°ä»»æ„æ­¥ï¼Œä½†æ˜¯è‹¥ç›®æ ‡æ ¼å­å’Œå½“å‰æ ¼å­çš„ä¸¤ä¸ªå…¬å…±ç›¸é‚»æ ¼å­å…¨éƒ¨éç©ºï¼Œåˆ™ä¸èƒ½ç§»åŠ¨è‡³ç›®æ ‡æ ¼å­ã€‚<br>
                    <span style="display: inline-block; font-size: 16px; background: linear-gradient(45deg, #000 25%, #fff 25%, #fff 50%, #000 50%, #000 75%, #fff 75%); background-size: 6px 6px; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">â®</span>ï¼šå¯ä»¥å¾€ä¸€ä¸ªæ–¹å‘è·³è·ƒã€‚è‹¥è¯¥æ–¹å‘æ²¡æœ‰ç›¸é‚»æ£‹å­åˆ™ä¸å¯ç§»åŠ¨ã€‚<br>
                    <span style="display: inline-block; font-size: 20px; background: linear-gradient(45deg, #000 25%, #fff 25%, #fff 50%, #000 50%, #000 75%, #fff 75%); background-size: 6px 6px; -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">â­</span>ï¼šå¯ä»¥å‹åœ¨åˆ«çš„æ£‹å­ä¸Šï¼Œä½¿å…¶æ— æ³•ç§»åŠ¨ã€‚<br><br>
                    åœ¨å·¦ä¸‹è§’è¿˜å¯ä»¥æ‰“å¼€è¿™ä¸ªç®€ä»‹ã€‚<br>
                    ç©å¾—æ„‰å¿«ï¼
                </p>
                <button class="restart-button" onclick="closeNewbieHint()">æˆ‘çŸ¥é“äº†</button>
            </div>
        </div>
        
        <!-- å·¦ä¸‹è§’åœ†å½¢æ•™ç¨‹æŒ‰é’® -->
        <button id="tutorialButton" style="position: absolute; bottom: 20px; left: 20px; width: 40px; height: 40px; border-radius: 50%; background-color: #4a90e2; color: white; border: none; font-size: 18px; cursor: pointer; box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); z-index: 1000; transition: all 0.3s ease;">?</button>
    </div>
    
    <script>
        // æ£‹ç›˜å¤§å°é…ç½®
        const BOARD_SIZE = 50;
        
        // è·å–æ£‹ç›˜å®¹å™¨
        const board = document.getElementById('hexBoard');
        
        // ç”Ÿæˆå…­è¾¹å½¢æ£‹ç›˜
        function generateBoard() {
            for (let i = 0; i < BOARD_SIZE; i++) {
                const row = document.createElement('div');
                row.className = 'row';
                
                // å¥‡æ•°è¡Œåç§»
                if (i % 2 === 1) {
                    row.classList.add('offset');
                }
                
                // æ¯è¡Œçš„å…­è¾¹å½¢æ•°é‡
                const hexCount = BOARD_SIZE;
                
                for (let j = 0; j < hexCount; j++) {
                    const hex = document.createElement('div');
                    hex.className = 'hex';
                    hex.dataset.row = i;
                    hex.dataset.col = j;
                    row.appendChild(hex);
                }
                
                board.appendChild(row);
            }
        }
        
        // åˆå§‹åŒ–æ£‹ç›˜
        generateBoard();
        
        // æ¸¸æˆçŠ¶æ€ç®¡ç†
        const boardState = new Map(); // å­˜å‚¨æ£‹ç›˜çŠ¶æ€ï¼Œé”®ä¸º"row-col"ï¼Œå€¼ä¸º{ pieces: [{ player: 'player1/player2', type: 'template/target/square/circle/jump/press' }, ...] }
        let currentPlayer = 'player1'; // å½“å‰ç©å®¶ï¼Œplayer1æˆ–player2
        let selectedHex = null; // å½“å‰é€‰ä¸­çš„å…­è¾¹å½¢
        let selectedPiece = null; // å½“å‰é€‰ä¸­çš„æ£‹å­
        let currentPieceType = 'template'; // å½“å‰è¦æ”¾ç½®çš„æ£‹å­ç±»å‹ï¼štemplate/target/square/circle/jump/press
        
        // å›åˆç®¡ç†
        let playerTurns = {
            player1: 0,
            player2: 0
        };
        
        // ç›®æ ‡æ£‹å­æ”¾ç½®çŠ¶æ€
        let hasPlacedTarget = {
            player1: false,
            player2: false
        };
        
        // æ–¹æ–¹æ£‹å­ç§»åŠ¨çŠ¶æ€
        let squareMoveState = {
            inProgress: false, // æ˜¯å¦æ­£åœ¨è¿›è¡Œè¿ç»­ç§»åŠ¨
            remainingMoves: 0, // å‰©ä½™ç§»åŠ¨æ¬¡æ•°
            currentPiece: null, // å½“å‰ç§»åŠ¨çš„æ–¹æ–¹æ£‹å­
            currentPath: [] // å½“å‰ç§»åŠ¨è·¯å¾„
        };
        
        // æ£‹å­åº“ç®¡ç†
        const pieceCount = {
            player1: {
                template: 2,
                target: 1,
                square: 2,
                circle: 2,
                jump: 2,
                press: 2
            },
            player2: {
                template: 2,
                target: 1,
                square: 2,
                circle: 2,
                jump: 2,
                press: 2
            }
        };
        
        // æ›´æ–°æ£‹å­åº“UI
        function updatePieceLibrary() {
            // æ›´æ–°çº¢æ–¹æ¨¡æ¿æ£‹å­åº“
            const redTemplateCount = document.querySelector('#player1TemplateLibrary .piece-count');
            redTemplateCount.textContent = pieceCount.player1.template;
            
            // æ›´æ–°çº¢æ–¹ç›®æ ‡æ£‹å­åº“
            const redTargetCount = document.querySelector('#player1TargetLibrary .piece-count');
            redTargetCount.textContent = pieceCount.player1.target;
            
            // æ›´æ–°çº¢æ–¹æ–¹æ–¹æ£‹å­åº“
            const redSquareCount = document.querySelector('#player1SquareLibrary .piece-count');
            redSquareCount.textContent = pieceCount.player1.square;
            
            // æ›´æ–°çº¢æ–¹åœ†åœ†æ£‹å­åº“
            const redCircleCount = document.querySelector('#player1CircleLibrary .piece-count');
            redCircleCount.textContent = pieceCount.player1.circle;
            
            // æ›´æ–°çº¢æ–¹è·³è·³æ£‹å­åº“
            const redJumpCount = document.querySelector('#player1JumpLibrary .piece-count');
            redJumpCount.textContent = pieceCount.player1.jump;
            
            // æ›´æ–°çº¢æ–¹å‹å‹æ£‹å­åº“
            const redPressCount = document.querySelector('#player1PressLibrary .piece-count');
            redPressCount.textContent = pieceCount.player1.press;
            
            // æ›´æ–°é»„æ–¹æ¨¡æ¿æ£‹å­åº“
            const yellowTemplateCount = document.querySelector('#player2TemplateLibrary .piece-count');
            yellowTemplateCount.textContent = pieceCount.player2.template;
            
            // æ›´æ–°é»„æ–¹ç›®æ ‡æ£‹å­åº“
            const yellowTargetCount = document.querySelector('#player2TargetLibrary .piece-count');
            yellowTargetCount.textContent = pieceCount.player2.target;
            
            // æ›´æ–°é»„æ–¹æ–¹æ–¹æ£‹å­åº“
            const yellowSquareCount = document.querySelector('#player2SquareLibrary .piece-count');
            yellowSquareCount.textContent = pieceCount.player2.square;
            
            // æ›´æ–°é»„æ–¹åœ†åœ†æ£‹å­åº“
            const yellowCircleCount = document.querySelector('#player2CircleLibrary .piece-count');
            yellowCircleCount.textContent = pieceCount.player2.circle;
            
            // æ›´æ–°é»„æ–¹è·³è·³æ£‹å­åº“
            const yellowJumpCount = document.querySelector('#player2JumpLibrary .piece-count');
            yellowJumpCount.textContent = pieceCount.player2.jump;
            
            // æ›´æ–°é»„æ–¹å‹å‹æ£‹å­åº“
            const yellowPressCount = document.querySelector('#player2PressLibrary .piece-count');
            yellowPressCount.textContent = pieceCount.player2.press;
        }
        
        // æ¸…é™¤æ‰€æœ‰é«˜äº®å’Œé€‰ä¸­çŠ¶æ€
        function clearHighlights() {
            // ç§»é™¤æ‰€æœ‰æ£‹ç›˜é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.hex.selected').forEach(hex => {
                hex.classList.remove('selected');
            });
            
            // ç§»é™¤æ‰€æœ‰å¯ç§»åŠ¨çŠ¶æ€å’Œæ— æ•ˆçŠ¶æ€
            document.querySelectorAll('.hex.movable').forEach(hex => {
                hex.classList.remove('movable');
                hex.classList.remove('invalid');
            });
            
            // ç§»é™¤æ‰€æœ‰æ£‹å­åº“é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.piece-selector.selected').forEach(selector => {
                selector.classList.remove('selected');
            });
            
            // é‡ç½®æ–¹æ–¹æ£‹å­è¿ç»­ç§»åŠ¨çŠ¶æ€
            squareMoveState.inProgress = false;
            squareMoveState.remainingMoves = 0;
            squareMoveState.currentPiece = null;
            squareMoveState.currentPath = [];
            
            selectedHex = null;
            selectedPiece = null;
        }
        
        // æŸ¥æ‰¾ç›¸é‚»çš„å¯ç§»åŠ¨æ ¼å­ï¼ˆæ™®é€šæ£‹å­ï¼‰
        function findAdjacentHexes(row, col) {
            const adjacent = [];
            const r = parseInt(row);
            const c = parseInt(col);
            
            // å…­è¾¹å½¢ç½‘æ ¼ä¸­æ¯ä¸ªæ ¼å­æœ‰6ä¸ªé‚»å±…
            // æ­£ç¡®çš„6ä¸ªç›¸é‚»æ–¹å‘ï¼Œè€ƒè™‘å¥‡å¶è¡Œå·®å¼‚
            const adjacentOffsets = [
                [-1, 0],  // ä¸Š
                [1, 0],   // ä¸‹
                [0, -1],  // å·¦
                [0, 1],   // å³
                [-1, -1], // å·¦ä¸Š even
                [-1, 1],  // å³ä¸Š
                [1, -1],  // å·¦ä¸‹ even
                [1, 1]    // å³ä¸‹
            ];
            
            // ä½¿ç”¨Setæ¥é¿å…é‡å¤å’Œé”™è¯¯çš„ç›¸é‚»å…³ç³»
            const validAdjacent = new Set();
            
            // å¯¹äºå…­è¾¹å½¢ç½‘æ ¼ï¼Œæ ¹æ®è¡Œçš„å¥‡å¶æ€§ï¼Œå¯¹è§’çº¿é‚»å±…ä¼šæœ‰ä¸åŒçš„è¡¨ç°
            // æ¯ä¸ªå…­è¾¹å½¢åªæœ‰6ä¸ªé‚»å±…
            adjacentOffsets.forEach(([dr, dc]) => {
                const newR = r + dr;
                let newC = c + dc;
                
                // æ£€æŸ¥è¾¹ç•Œ
                if (newR >= 0 && newR < BOARD_SIZE && newC >= 0 && newC < BOARD_SIZE) {
                    // å¯¹äºå¶æ•°è¡Œï¼Œåªæœ‰ç‰¹å®šçš„å¯¹è§’çº¿é‚»å±…æ˜¯æœ‰æ•ˆçš„
                    if (r % 2 === 0) {
                        // å¶æ•°è¡Œï¼šå·¦ä¸Šã€å·¦ä¸‹æ˜¯æœ‰æ•ˆçš„å¯¹è§’çº¿é‚»å±…
                        if (dr === -1 && dc === -1) validAdjacent.add(`${newR}-${newC}`); // å·¦ä¸Š
                        if (dr === 1 && dc === -1) validAdjacent.add(`${newR}-${newC}`); // å·¦ä¸‹
                        // ä¸Šä¸‹å·¦å³éƒ½æ˜¯æœ‰æ•ˆçš„
                        if (Math.abs(dr) + Math.abs(dc) === 1) validAdjacent.add(`${newR}-${newC}`);
                    } else {
                        // å¥‡æ•°è¡Œï¼šå³ä¸Šã€å³ä¸‹æ˜¯æœ‰æ•ˆçš„å¯¹è§’çº¿é‚»å±…
                        if (dr === -1 && dc === 1) validAdjacent.add(`${newR}-${newC}`); // å³ä¸Š
                        if (dr === 1 && dc === 1) validAdjacent.add(`${newR}-${newC}`); // å³ä¸‹
                        // ä¸Šä¸‹å·¦å³éƒ½æ˜¯æœ‰æ•ˆçš„
                        if (Math.abs(dr) + Math.abs(dc) === 1) validAdjacent.add(`${newR}-${newC}`);
                    }
                }
            });
            
            // è½¬æ¢ä¸ºæ•°ç»„
            validAdjacent.forEach(pos => {
                const [newR, newC] = pos.split('-').map(Number);
                adjacent.push({row: newR, col: newC});
            });
            
            return adjacent;
        }
        
        // è®¡ç®—ä¸¤ä¸ªç›¸é‚»æ ¼å­çš„å…¬å…±ç›¸é‚»æ ¼å­
        function getCommonAdjacentCells(fromRow, fromCol, toRow, toCol) {
            // è·å–ä¸¤ä¸ªæ ¼å­çš„ç›¸é‚»æ ¼å­
            const fromAdjacent = getAdjacentCells(fromRow, fromCol).map(cell => `${cell.row}-${cell.col}`);
            const toAdjacent = getAdjacentCells(toRow, toCol).map(cell => `${cell.row}-${cell.col}`);
            
            // æ‰¾åˆ°å…¬å…±ç›¸é‚»æ ¼å­ï¼ˆæ’é™¤å½¼æ­¤ï¼‰
            const commonAdjacent = [];
            const fromKey = `${fromRow}-${fromCol}`;
            const toKey = `${toRow}-${toCol}`;
            
            // éå†fromçš„ç›¸é‚»æ ¼å­ï¼Œæ‰¾åˆ°ä¹Ÿåœ¨toçš„ç›¸é‚»æ ¼å­ä¸­çš„æ ¼å­ï¼Œä¸”ä¸æ˜¯å¯¹æ–¹
            for (const cellKey of fromAdjacent) {
                if (cellKey !== toKey && toAdjacent.includes(cellKey)) {
                    const [row, col] = cellKey.split('-').map(Number);
                    commonAdjacent.push({row, col});
                }
            }
            
            return commonAdjacent;
        }
        
        // æŸ¥æ‰¾æ‰€æœ‰å¯è¾¾çš„æ ¼å­ï¼ˆåœ†åœ†æ£‹å­ï¼‰
        function findAllReachableHexes(row, col) {
            const reachable = [];
            const visited = new Set();
            const queue = [];
            
            // åˆå§‹ä½ç½®
            queue.push({row: parseInt(row), col: parseInt(col)});
            visited.add(`${row}-${col}`);
            
            // BFSéå†æ‰€æœ‰å¯è¾¾æ ¼å­
            while (queue.length > 0) {
                const current = queue.shift();
                const adjacents = findAdjacentHexes(current.row, current.col);
                
                for (const adjacent of adjacents) {
                    const posKey = `${adjacent.row}-${adjacent.col}`;
                    if (!visited.has(posKey)) {
                        // è®¡ç®—å½“å‰æ ¼å­å’Œç›¸é‚»æ ¼å­çš„å…¬å…±ç›¸é‚»æ ¼å­
                        const commonAdjacents = getCommonAdjacentCells(current.row, current.col, adjacent.row, adjacent.col);
                        
                        // æ£€æŸ¥å…¬å…±ç›¸é‚»æ ¼å­æ˜¯å¦å…¨éƒ¨éç©º
                        const allCommonNonEmpty = commonAdjacents.every(cell => {
                            const cellKey = `${cell.row}-${cell.col}`;
                            return boardState.has(cellKey);
                        });
                        
                        // å¦‚æœå…¬å…±ç›¸é‚»æ ¼å­å…¨éƒ¨éç©ºï¼Œåˆ™è·³è¿‡è¯¥ç›¸é‚»æ ¼å­
                        if (allCommonNonEmpty) {
                            continue;
                        }
                        
                        visited.add(posKey);
                        
                        // æ·»åŠ åˆ°å¯è¾¾åˆ—è¡¨
                        reachable.push(adjacent);
                        
                        // æ£€æŸ¥æ˜¯å¦ä¸ºç©ºæ ¼å­ï¼Œå¦‚æœæ˜¯ï¼Œæ‰å…¥é˜Ÿç»§ç»­æ‰©å±•æœç´¢
                        const cellState = boardState.get(posKey);
                        if (!cellState) {
                            queue.push(adjacent);
                        }
                    }
                }
            }
            
            // è¿‡æ»¤å¯è¾¾æ ¼å­ï¼Œåªä¿ç•™æ»¡è¶³æ¡ä»¶çš„æ ¼å­
            const filteredReachable = reachable.filter(hex => {
                const key = `${hex.row}-${hex.col}`;
                const cellState = boardState.get(key);
                
                // æ¡ä»¶1ï¼šå¿…é¡»æ˜¯ç©ºæ ¼
                const isEmpty = !cellState;
                
                if (!isEmpty) {
                    return false;
                }
                
                // æ¡ä»¶2ï¼šå¦‚æœæ˜¯ç©ºæ ¼ï¼Œç›¸é‚»çš„æ ¼å­ä¸­è‡³å°‘æœ‰ä¸€ä¸ªéç©ºçš„æ ¼å­
                if (isEmpty) {
                    // è·å–æ‰€æœ‰ç›¸é‚»çš„æ ¼å­ï¼ˆä½¿ç”¨getAdjacentCellsè·å–æ‰€æœ‰ç›¸é‚»æ ¼å­ï¼Œä¸ç®¡æ˜¯å¦ä¸ºç©ºï¼‰
                    const adjacentHexes = getAdjacentCells(hex.row, hex.col);
                    // æ£€æŸ¥æ˜¯å¦æœ‰è‡³å°‘ä¸€ä¸ªç›¸é‚»æ ¼å­éç©º
                    const hasNonEmptyNeighbor = adjacentHexes.some(adjacent => {
                        const adjKey = `${adjacent.row}-${adjacent.col}`;
                        return boardState.has(adjKey);
                    });
                    
                    return hasNonEmptyNeighbor;
                }
                
                return false;
            });
            
            return filteredReachable;
        }
        
        // é¢„æ£€æŸ¥ç§»åŠ¨æ˜¯å¦åˆæ³•
        function isMoveValid(fromRow, fromCol, toRow, toCol) {
            const fromKey = `${fromRow}-${fromCol}`;
            const toKey = `${toRow}-${toCol}`;
            
            // è·å–æ£‹å­ä¿¡æ¯
            const fromState = boardState.get(fromKey);
            if (!fromState || fromState.pieces.length === 0) {
                return false;
            }
            
            // è·å–è¦ç§»åŠ¨çš„æ£‹å­ï¼ˆæœ€ä¸Šé¢çš„æ£‹å­ï¼‰
            const pieceToMove = fromState.pieces[fromState.pieces.length - 1];
            
            // åˆ›å»ºä¸´æ—¶çŠ¶æ€è¿›è¡Œæ£€æŸ¥
            const tempBoardState = new Map();
            // å¤åˆ¶æ‰€æœ‰çŠ¶æ€
            for (const [key, state] of boardState) {
                tempBoardState.set(key, { pieces: [...state.pieces] });
            }
            
            // æ‰§è¡Œä¸´æ—¶ç§»åŠ¨
            // ä»åŸä½ç½®ç§»é™¤æ£‹å­
            const tempFromState = tempBoardState.get(fromKey);
            tempFromState.pieces.pop();
            if (tempFromState.pieces.length === 0) {
                tempBoardState.delete(fromKey);
            }
            
            // æ·»åŠ åˆ°ç›®æ ‡ä½ç½®
            if (tempBoardState.has(toKey)) {
                tempBoardState.get(toKey).pieces.push(pieceToMove);
            } else {
                tempBoardState.set(toKey, { pieces: [pieceToMove] });
            }
            
            // æ£€æŸ¥è¿é€šæ€§
            // ä¿å­˜å½“å‰çŠ¶æ€
            const originalBoardState = new Map();
            for (const [key, state] of boardState) {
                originalBoardState.set(key, { pieces: [...state.pieces] });
            }
            
            // ä¸´æ—¶æ›¿æ¢æ£‹ç›˜çŠ¶æ€
            boardState.clear();
            for (const [key, state] of tempBoardState) {
                boardState.set(key, state);
            }
            
            // æ£€æŸ¥è¿é€šæ€§
            const isValid = isConnected();
            
            // æ¢å¤åŸå§‹çŠ¶æ€
            boardState.clear();
            for (const [key, state] of originalBoardState) {
                boardState.set(key, state);
            }
            
            return isValid;
        }
        
        // æŸ¥æ‰¾è·³è·³æ£‹å­çš„å¯ç§»åŠ¨æ ¼å­
        function findJumpMovableHexes(row, col) {
            const movable = [];
            const r = parseInt(row);
            const c = parseInt(col);
            
            // å…­è¾¹å½¢çš„6ä¸ªæ–¹å‘ï¼Œè€ƒè™‘å¥‡å¶è¡Œå·®å¼‚
            let directions;
            if (r % 2 === 0) {
                // å¶æ•°è¡Œçš„6ä¸ªæ–¹å‘
                directions = [
                    [-1, 0],  // ä¸Š
                    [1, 0],   // ä¸‹
                    [0, -1],  // å·¦
                    [0, 1],   // å³
                    [-1, -1], // å·¦ä¸Š
                    [1, -1]   // å·¦ä¸‹
                ];
            } else {
                // å¥‡æ•°è¡Œçš„6ä¸ªæ–¹å‘
                directions = [
                    [-1, 0],  // ä¸Š
                    [1, 0],   // ä¸‹
                    [0, -1],  // å·¦
                    [0, 1],   // å³
                    [-1, 1],  // å³ä¸Š
                    [1, 1]    // å³ä¸‹
                ];
            }
            
            let i;let dc;let dr;
            // æ£€æŸ¥æ¯ä¸ªæ–¹å‘ä¸Šçš„ç¬¬ä¸€ä¸ªç©ºæ ¼
            for (i=0;i<6;i+=1) {
                let nr = r;
                let nc = c;
                let foundNonEmpty = false;
                
                // æ²¿ç€æ–¹å‘ç§»åŠ¨ï¼Œç›´åˆ°æ‰¾åˆ°ç©ºæ ¼ã€ç›®æ ‡æ£‹å­æˆ–è¶…å‡ºè¾¹ç•Œ
                while (true) {
                     if (nr % 2 === 0) {
                        // å¶æ•°è¡Œçš„6ä¸ªæ–¹å‘
                        directions = [
                            [-1, -1], // å·¦ä¸Š
                            [1, -1],   // å·¦ä¸‹
                            [-1, 0],  // ä¸Š
                            [1, 0],   // ä¸‹
                            [0, -1],  // å·¦
                            [0, 1],   // å³
                        ];
                    } else {
                        // å¥‡æ•°è¡Œçš„6ä¸ªæ–¹å‘
                        directions = [
                            [-1, 0],  // ä¸Š
                            [1, 0],   // ä¸‹
                            [-1, 1],  // å³ä¸Š
                            [1, 1],    // å³ä¸‹
                            [0, -1],  // å·¦
                            [0, 1]   // å³
                        ];
                    }
                    dr=directions[i][0];dc=directions[i][1];
                    nr += dr;
                    nc += dc;
                    
                    // æ£€æŸ¥æ˜¯å¦è¶…å‡ºè¾¹ç•Œ
                    if (nr < 0 || nr >= BOARD_SIZE || nc < 0 || nc >= BOARD_SIZE) {
                        break;
                    }
                    
                    const key = `${nr}-${nc}`;
                    const cell = boardState.get(key);
                    
                    // æ£€æŸ¥å½“å‰æ ¼å­
                    if (!cell) {
                        // æ‰¾åˆ°ç©ºæ ¼
                        if (foundNonEmpty) {
                            // å·²ç»è·³è¿‡äº†éç©ºæ ¼å­ï¼Œæ‰€ä»¥è¿™ä¸ªç©ºæ ¼æ˜¯æœ‰æ•ˆçš„
                            movable.push({row: nr, col: nc});
                        };break;
                    }else {
                        // æ‰¾åˆ°éç©ºæ ¼å­ï¼Œæ ‡è®°ä¸ºå·²æ‰¾åˆ°
                        foundNonEmpty = true;
                    }
                }
            }
            
            return movable;
        }
        
        // æŸ¥æ‰¾å‹å‹æ£‹å­çš„å¯ç§»åŠ¨æ ¼å­
        function findPressMovableHexes(row, col) {
            const movable = [];
            const r = parseInt(row);
            const c = parseInt(col);
            
            // å…­è¾¹å½¢çš„6ä¸ªæ–¹å‘ï¼Œè€ƒè™‘å¥‡å¶è¡Œå·®å¼‚
            let directions;
            if (r % 2 === 0) {
                // å¶æ•°è¡Œçš„6ä¸ªæ–¹å‘
                directions = [
                    [-1, 0],  // ä¸Š
                    [1, 0],   // ä¸‹
                    [0, -1],  // å·¦
                    [0, 1],   // å³
                    [-1, -1], // å·¦ä¸Š
                    [1, -1]   // å·¦ä¸‹
                ];
            } else {
                // å¥‡æ•°è¡Œçš„6ä¸ªæ–¹å‘
                directions = [
                    [-1, 0],  // ä¸Š
                    [1, 0],   // ä¸‹
                    [0, -1],  // å·¦
                    [0, 1],   // å³
                    [-1, 1],  // å³ä¸Š
                    [1, 1]    // å³ä¸‹
                ];
            }
            
            // æ£€æŸ¥æ¯ä¸ªç›¸é‚»æ ¼å­ï¼ŒåŒ…æ‹¬æœ‰æ£‹å­çš„æ ¼å­
            for (const [dr, dc] of directions) {
                const nr = r + dr;
                const nc = c + dc;
                
                // æ£€æŸ¥æ˜¯å¦è¶…å‡ºè¾¹ç•Œ
                if (nr >= 0 && nr < BOARD_SIZE && nc >= 0 && nc < BOARD_SIZE) {
                    // å‹å‹æ£‹å­å¯ä»¥ç§»åŠ¨åˆ°ä»»ä½•ç›¸é‚»æ ¼å­ï¼ŒåŒ…æ‹¬æœ‰æ£‹å­çš„æ ¼å­
                    movable.push({row: nr, col: nc});
                }
            }
            
            return movable;
        }
        
        // é«˜äº®å¯ç§»åŠ¨æ ¼å­
        function highlightMovableHexes(row, col) {
            let movableHexes = [];
            
            // æ£€æŸ¥å½“å‰é€‰ä¸­çš„æ£‹å­ç±»å‹
            let pieceType = 'template';
            let isPressPiece = false;
            if (selectedPiece.classList.contains('square')) {
                pieceType = 'square';
            } else if (selectedPiece.classList.contains('circle')) {
                pieceType = 'circle';
            } else if (selectedPiece.classList.contains('jump')) {
                pieceType = 'jump';
            } else if (selectedPiece.classList.contains('press')) {
                pieceType = 'press';
                isPressPiece = true;
            }
            
            if (isPressPiece) {
                // å‹å‹æ£‹å­ï¼šå¯ä»¥ç§»åŠ¨åˆ°ä»»ä½•ç›¸é‚»æ ¼å­ï¼ŒåŒ…æ‹¬æœ‰æ£‹å­çš„æ ¼å­
                movableHexes = findPressMovableHexes(row, col);
            } else if (pieceType === 'circle') {
                // åœ†åœ†æ£‹å­ï¼šæŸ¥æ‰¾æ‰€æœ‰å¯è¾¾æ ¼å­
                movableHexes = findAllReachableHexes(row, col);
            } else if (pieceType === 'jump') {
                // è·³è·³æ£‹å­ï¼šæŸ¥æ‰¾æ¯ä¸ªæ–¹å‘ä¸Šçš„ç¬¬ä¸€ä¸ªç©ºæ ¼ï¼ˆè·³è¿‡ç›¸é‚»çš„éç©ºæ ¼ï¼‰
                movableHexes = findJumpMovableHexes(row, col);
            } else {
                // å…¶ä»–æ£‹å­ï¼šæŸ¥æ‰¾ç›¸é‚»æ ¼å­
                movableHexes = findAdjacentHexes(row, col);
            }
            
            movableHexes.forEach(({row: toRow, col: toCol}) => {
                const hexElement = document.querySelector(`[data-row="${toRow}"][data-col="${toCol}"]`);
                if (hexElement) {
                    // æ£€æŸ¥ç›®æ ‡ä½ç½®æ˜¯å¦ä¸ºç©ºï¼Œæˆ–è€…æ˜¯å‹å‹æ£‹å­
                    const toKey = `${toRow}-${toCol}`;
                    const toState = boardState.get(toKey);
                    
                    // æ™®é€šæ£‹å­åªèƒ½ç§»åŠ¨åˆ°ç©ºçš„æ ¼å­ä¸Šï¼Œå‹å‹æ£‹å­å¯ä»¥ç§»åŠ¨åˆ°ä»»ä½•æ ¼å­
                    if (!isPressPiece && toState) {
                        return; // æ™®é€šæ£‹å­ä¸èƒ½ç§»åŠ¨åˆ°æœ‰æ£‹å­çš„æ ¼å­ä¸Š
                    }
                    
                    hexElement.classList.add('movable');
                    
                    // é¢„æ£€æŸ¥ç§»åŠ¨æ˜¯å¦åˆæ³•ï¼Œæ‰€æœ‰æ£‹å­éƒ½éœ€è¦è¿›è¡Œè¿é€šæ€§æ£€æŸ¥
                    if (!isMoveValid(row, col, toRow, toCol)) {
                        hexElement.classList.add('invalid');
                    }
                }
            });
        }
        
        // é€‰ä¸­æ£‹å­
        function selectPiece(hexElement) {
            // æ¸…é™¤ä¹‹å‰çš„é€‰ä¸­çŠ¶æ€ï¼ˆå¦‚æœä¸æ˜¯æ–¹æ–¹æ£‹å­çš„è¿ç»­ç§»åŠ¨ï¼‰
            if (!squareMoveState.inProgress) {
                clearHighlights();
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰æ£‹å­ï¼Œè·å–æœ€ä¸Šé¢çš„æ£‹å­ï¼ˆæœ€åä¸€ä¸ªå­å…ƒç´ ï¼‰
            const pieces = hexElement.querySelectorAll('.piece');
            if (pieces.length === 0) return;
            const piece = pieces[pieces.length - 1]; // æœ€ä¸Šé¢çš„æ£‹å­
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰ç©å®¶çš„æ£‹å­
            if (!piece.classList.contains(currentPlayer)) return;
            
            // ç¬¬ä¸‰å›åˆç‰¹æ®Šé€»è¾‘ï¼šå¦‚æœæ˜¯ç¬¬ä¸‰å›åˆä¸”æœªæ”¾ç½®ç›®æ ‡æ£‹å­ï¼Œä¸èƒ½ç§»åŠ¨æ£‹å­
            if (playerTurns[currentPlayer] === 2 && !hasPlacedTarget[currentPlayer]) {
                return; // ç¬¬ä¸‰å›åˆæœªæ”¾ç½®ç›®æ ‡æ£‹å­ï¼Œä¸èƒ½ç§»åŠ¨æ£‹å­
            }
            
            // è·å–å½“å‰ä½ç½®çš„æ£‹å­çŠ¶æ€
            const row = hexElement.dataset.row;
            const col = hexElement.dataset.col;
            const key = `${row}-${col}`;
            const cellState = boardState.get(key);
            
            if (!cellState) {
                return;
            }
            
            // æ£€æŸ¥æ£‹å­æ˜¯å¦è¢«å‹ä½ï¼šåªæœ‰æœ€ä¸Šé¢çš„æ£‹å­æ‰èƒ½è¢«é€‰ä¸­å’Œç§»åŠ¨
            // ç”±äºæˆ‘ä»¬çš„DOMç»“æ„åªæ˜¾ç¤ºæœ€ä¸Šé¢çš„æ£‹å­ï¼Œæ‰€ä»¥å½“å‰é€‰ä¸­çš„æ£‹å­åº”è¯¥å°±æ˜¯æœ€ä¸Šé¢çš„æ£‹å­
            // ä½†æ˜¯æˆ‘ä»¬éœ€è¦ç¡®ä¿è¿™ä¸€ç‚¹
            const topPiece = cellState.pieces[cellState.pieces.length - 1];
            const pieceClass = `${topPiece.player} ${topPiece.type}`;
            
            // æ£€æŸ¥å½“å‰é€‰ä¸­çš„æ£‹å­æ˜¯å¦æ˜¯æœ€ä¸Šé¢çš„æ£‹å­
            if (!piece.classList.contains(pieceClass.split(' ')[1])) {
                return; // è¢«å‹ä½çš„æ£‹å­ä¸èƒ½è¢«é€‰ä¸­å’Œç§»åŠ¨
            }
            
            // è®¾ç½®é€‰ä¸­çŠ¶æ€
            hexElement.classList.add('selected');
            selectedHex = hexElement;
            selectedPiece = piece;
            
            // é«˜äº®å¯ç§»åŠ¨æ ¼å­
            highlightMovableHexes(row, col);
        }
        
        // è¿é€šæ€§æ£€æŸ¥ - è·å–æ‰€æœ‰ç›¸é‚»æ ¼å­
        // ä½¿ç”¨ä¸ç§»åŠ¨æ£‹å­ç›¸åŒçš„ç›¸é‚»åˆ¤å®šé€»è¾‘
        function getAdjacentCells(row, col) {
            const r = parseInt(row);
            const c = parseInt(col);
            let adjacentOffsets;
            
            // æ­£ç¡®çš„å…­è¾¹å½¢ç›¸é‚»æ–¹å‘ï¼Œè€ƒè™‘å¥‡å¶è¡Œå·®å¼‚
            if (r % 2 === 0) {
                // å¶æ•°è¡Œçš„6ä¸ªç›¸é‚»æ–¹å‘
                adjacentOffsets = [
                    [-1, 0],  // ä¸Š
                    [-1, -1], // å·¦ä¸Š
                    [0, 1],   // å³
                    [1, 0],   // ä¸‹
                    [1, -1],  // å·¦ä¸‹
                    [0, -1]   // å·¦
                ];
            } else {
                // å¥‡æ•°è¡Œçš„6ä¸ªç›¸é‚»æ–¹å‘
                adjacentOffsets = [
                    [-1, 0],  // ä¸Š
                    [-1, 1],  // å³ä¸Š
                    [0, 1],   // å³
                    [1, 0],   // ä¸‹
                    [1, 1],   // å³ä¸‹
                    [0, -1]   // å·¦
                ];
            }
            
            return adjacentOffsets.map(([dr, dc]) => {
                return { row: r + dr, col: c + dc };
            });
        }
        
        // è¿é€šæ€§æ£€æŸ¥ - DFSç®—æ³•
        // è¿é€šå¯ä»¥æ˜¯åŒè‰²ä¹Ÿå¯ä»¥æ˜¯å¼‚è‰²
        function isConnected() {
            // è·å–æ‰€æœ‰æ£‹å­æ ¼å­ï¼ˆä¸ç®¡æœ‰å¤šå°‘æ£‹å­ï¼‰
            const allPieceCells = [];
            for (const [key, state] of boardState.entries()) {
                const [row, col] = key.split('-').map(Number);
                allPieceCells.push({ row, col, key });
            }
            
            // å¦‚æœåªæœ‰0æˆ–1ä¸ªæ£‹å­æ ¼å­ï¼Œè‚¯å®šè¿é€š
            if (allPieceCells.length <= 1) {
                return true;
            }
            
            // DFSæ£€æŸ¥è¿é€šæ€§ï¼Œä¸åŒºåˆ†é¢œè‰²
            const visited = new Set();
            const start = allPieceCells[0];
            const stack = [start];
            visited.add(start.key);
            
            while (stack.length > 0) {
                const current = stack.pop();
                const adjacent = getAdjacentCells(current.row, current.col);
                
                for (const cell of adjacent) {
                    const cellKey = `${cell.row}-${cell.col}`;
                    if (!visited.has(cellKey)) {
                        // æ£€æŸ¥æ˜¯å¦æœ‰æ£‹å­ï¼ˆæ— è®ºé¢œè‰²ï¼‰
                        if (boardState.has(cellKey)) {
                            visited.add(cellKey);
                            stack.push({ row: cell.row, col: cell.col, key: cellKey });
                        }
                    }
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰æ£‹å­æ ¼å­éƒ½è¢«è®¿é—®åˆ°
            return visited.size === allPieceCells.length;
        }
        
        // æ£€æŸ¥ç›®æ ‡æ£‹å­å‘¨å›´æ˜¯å¦è¢«åŒ…å›´
        function _checkTargetSurrounded(opponent) {
            // éå†æ£‹ç›˜ï¼Œæ‰¾åˆ°å¯¹æ–¹çš„ç›®æ ‡æ£‹å­
            for (const [key, cellInfo] of boardState.entries()) {
                // æ£€æŸ¥å½“å‰æ ¼å­ä¸­æ˜¯å¦æœ‰å¯¹æ–¹çš„ç›®æ ‡æ£‹å­
                const hasOpponentTarget = cellInfo.pieces.some(piece => 
                    piece.player === opponent && piece.type === 'target'
                );
                
                if (hasOpponentTarget) {
                    const [row, col] = key.split('-').map(Number);
                    
                    // è·å–ç›®æ ‡æ£‹å­çš„æ‰€æœ‰ç›¸é‚»æ ¼å­
                    const adjacentCells = getAdjacentCells(row, col);
                    
                    // æ£€æŸ¥ç›¸é‚»æ ¼å­æ˜¯å¦éƒ½è¢«å ç”¨ï¼ˆè¢«åŒ…å›´çš„åˆ¤å®šï¼‰
                    let allSurrounded = true;
                    for (const cell of adjacentCells) {
                        const cellKey = `${cell.row}-${cell.col}`;
                        // æ£€æŸ¥æ˜¯å¦åœ¨æ£‹ç›˜èŒƒå›´å†…ä¸”ä¸ºç©º
                        if (cell.row >= 0 && cell.row < BOARD_SIZE && cell.col >= 0 && cell.col < BOARD_SIZE) {
                            if (!boardState.has(cellKey)) {
                                // æœ‰ç©ºæ ¼ï¼Œä¸æ˜¯è¢«å®Œå…¨åŒ…å›´
                                allSurrounded = false;
                                break;
                            }
                        }
                    }
                    
                    // å¦‚æœå¯¹æ–¹ç›®æ ‡æ£‹å­è¢«å®Œå…¨åŒ…å›´ï¼Œè¿”å›trueè¡¨ç¤ºè·èƒœ
                    if (allSurrounded) {
                        return true;
                    }
                }
            }
            return false;
        }
        function checkTargetSurrounded(){
            // æ£€æŸ¥åŒæ–¹æ˜¯å¦éƒ½è¢«åŒ…å›´
            const player1Win = _checkTargetSurrounded('player1');
            const player2Win = _checkTargetSurrounded('player2');
            
            if (player1Win && player2Win) {
                // åŒæ–¹å¹³å±€
                document.querySelector('.container').classList.add('game-over');
                const overlay = document.getElementById('gameOverOverlay');
                const text = document.getElementById('gameOverText');
                text.textContent = 'åŒæ–¹å¹³å±€';
                overlay.style.display = 'flex';
            } else if (player1Win) {
                gameOver('player1');
            } else if (player2Win) {
                gameOver('player2');
            }
        }
        
        // ç§»åŠ¨æ£‹å­
        function movePiece(fromHex, toHex) {
            // ç¬¬ä¸‰å›åˆç‰¹æ®Šé€»è¾‘ï¼šå¦‚æœæ˜¯ç¬¬ä¸‰å›åˆä¸”æœªæ”¾ç½®ç›®æ ‡æ£‹å­ï¼Œä¸èƒ½ç§»åŠ¨æ£‹å­
            if (playerTurns[currentPlayer] === 2 && !hasPlacedTarget[currentPlayer]) {
                return; // ç¬¬ä¸‰å›åˆæœªæ”¾ç½®ç›®æ ‡æ£‹å­ï¼Œä¸èƒ½ç§»åŠ¨æ£‹å­
            }
            
            const fromRow = fromHex.dataset.row;
            const fromCol = fromHex.dataset.col;
            const toRow = toHex.dataset.row;
            const toCol = toHex.dataset.col;
            
            const fromKey = `${fromRow}-${fromCol}`;
            const toKey = `${toRow}-${toCol}`;
            
            // è·å–æ£‹å­ä¿¡æ¯
            const pieceInfo = boardState.get(fromKey);
            
            // æ£€æŸ¥ç›®æ ‡ä½ç½®æ˜¯å¦æœ‰ç›®æ ‡æ£‹å­
            const targetInfo = boardState.get(toKey);
            const isTargetCell = targetInfo && targetInfo.pieces.some(piece => piece.type === 'target');
            
            // è·å–è¦ç§»åŠ¨çš„æ£‹å­ä¿¡æ¯ï¼ˆåœ¨ç§»é™¤ä¹‹å‰ï¼‰
            const fromState = boardState.get(fromKey);
            const pieceToMoveInfo = fromState.pieces[fromState.pieces.length - 1];
            const isPressPiece = pieceToMoveInfo.type === 'press';
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯ç›®æ ‡æ£‹å­ï¼Œæ™®é€šæ£‹å­ä¸èƒ½ç§»åŠ¨åˆ°ç›®æ ‡æ£‹å­ä¸Šæ–¹ï¼Œå‹å‹æ£‹å­å¯ä»¥
            if (isTargetCell && !isPressPiece) {
                return; // æ™®é€šæ£‹å­ä¸èƒ½ç§»åŠ¨åˆ°ç›®æ ‡æ£‹å­ä¸Šæ–¹
            }
            
            // ä¿å­˜åŸå§‹çŠ¶æ€ï¼Œç”¨äºæ’¤é”€
            const originalFromHex = fromHex.cloneNode(true);
            const originalToHex = toHex.cloneNode(true);
            const originalBoardState = new Map(boardState);
            
            // æ‰§è¡Œç§»åŠ¨æ“ä½œ
            // ç§»é™¤åŸä½ç½®æ£‹å­
            const pieceToMove = fromHex.removeChild(selectedPiece);
            
            // æ·»åŠ åˆ°æ–°ä½ç½®
            toHex.appendChild(pieceToMove);
            
            // æ›´æ–°æ£‹ç›˜çŠ¶æ€
            // ç§»é™¤å¹¶è·å–è¦ç§»åŠ¨çš„æ£‹å­ä¿¡æ¯
            const movedPieceInfo = boardState.get(fromKey).pieces.pop();
            
            // å¦‚æœåŸä½ç½®æ²¡æœ‰æ£‹å­äº†ï¼Œåˆ é™¤è¯¥ä½ç½®çš„çŠ¶æ€
            if (boardState.get(fromKey).pieces.length === 0) {
                boardState.delete(fromKey);
            }
            
            // å¤„ç†ç›®æ ‡ä½ç½®çš„çŠ¶æ€
            if (boardState.has(toKey)) {
                // ç›®æ ‡ä½ç½®å·²æœ‰æ£‹å­ï¼Œå°†å½“å‰æ£‹å­æ”¾åœ¨æœ€ä¸Šé¢
                boardState.get(toKey).pieces.push(movedPieceInfo);
            } else {
                // ç›®æ ‡ä½ç½®æ²¡æœ‰æ£‹å­ï¼Œåˆ›å»ºæ–°çš„çŠ¶æ€
                boardState.set(toKey, { pieces: [movedPieceInfo] });
            }
            
            // æ£€æŸ¥è¿é€šæ€§
            if (!isConnected()) {
                // è¿é€šæ€§æ£€æŸ¥å¤±è´¥ï¼Œæ’¤é”€æ“ä½œ
                // æ¢å¤æ£‹ç›˜çŠ¶æ€
                boardState.clear();
                for (const [key, info] of originalBoardState) {
                    boardState.set(key, info);
                }
                
                // æ¢å¤DOM
                fromHex.innerHTML = originalFromHex.innerHTML;
                toHex.innerHTML = originalToHex.innerHTML;
                
                // ä¿æŒé€‰ä¸­çŠ¶æ€
                fromHex.classList.add('selected');
                selectedHex = fromHex;
                selectedPiece = fromHex.querySelector('.piece');
                
                // é‡æ–°é«˜äº®å¯ç§»åŠ¨æ ¼å­
                highlightMovableHexes(fromRow, fromCol);
                
                return; // æ“ä½œæ’¤é”€ï¼Œä¸åˆ‡æ¢ç©å®¶
            }
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯æ–¹æ–¹æ£‹å­
            const isSquarePiece = pieceToMoveInfo.type === 'square';
            
            if (isSquarePiece) {
                if (squareMoveState.inProgress) {
                    // æ›´æ–°æ–¹æ–¹æ£‹å­ç§»åŠ¨çŠ¶æ€
                    squareMoveState.remainingMoves--;
                    squareMoveState.currentPath.push({row: toRow, col: toCol});
                    
                    // æ£€æŸ¥æ˜¯å¦è¿˜æœ‰å‰©ä½™ç§»åŠ¨æ¬¡æ•°
                    if (squareMoveState.remainingMoves > 0) {
                        // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
                        document.querySelectorAll('.hex.movable').forEach(hex => {
                            hex.classList.remove('movable');
                            hex.classList.remove('invalid');
                        });
                        
                        // ä¿æŒå½“å‰æ£‹å­é€‰ä¸­çŠ¶æ€
                        selectedHex = toHex;
                        selectedPiece = pieceToMove;
                        toHex.classList.add('selected');
                        
                        // é«˜äº®ä¸‹ä¸€æ¬¡å¯ç§»åŠ¨çš„æ ¼å­
                        highlightMovableHexes(toRow, toCol);
                        
                        return; // ç»§ç»­è¿ç»­ç§»åŠ¨ï¼Œä¸åˆ‡æ¢ç©å®¶
                    } else {
                        // æ–¹æ–¹æ£‹å­çš„ä¸‰æ¬¡ç§»åŠ¨å®Œæˆ
                        squareMoveState.inProgress = false;
                        clearHighlights();
                        
                        // ç§»åŠ¨æ£‹å­åŠŸèƒ½æˆåŠŸï¼Œå¢åŠ å›åˆæ•°
                        playerTurns[currentPlayer]++;
                        
                        // æ£€æŸ¥å¯¹æ–¹ç›®æ ‡æ£‹å­æ˜¯å¦è¢«åŒ…å›´
                        checkTargetSurrounded();
                        
                        // åˆ‡æ¢ç©å®¶
                        currentPlayer = currentPlayer === 'player1' ? 'player2' : 'player1';
                    }
                } else {
                    // æ–¹æ–¹æ£‹å­ç¬¬ä¸€æ¬¡ç§»åŠ¨ï¼Œå¼€å§‹è¿ç»­ç§»åŠ¨
                    squareMoveState.inProgress = true;
                    squareMoveState.remainingMoves = 2; // å·²ç»ç§»åŠ¨äº†1æ¬¡ï¼Œè¿˜å¯ä»¥ç§»åŠ¨2æ¬¡ï¼Œæ€»å…±3æ¬¡
                    squareMoveState.currentPiece = pieceToMove;
                    squareMoveState.currentPath = [{row: fromRow, col: fromCol}, {row: toRow, col: toCol}];
                    
                    // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
                    document.querySelectorAll('.hex.movable').forEach(hex => {
                        hex.classList.remove('movable');
                        hex.classList.remove('invalid');
                    });
                    
                    // ä¿æŒå½“å‰æ£‹å­é€‰ä¸­çŠ¶æ€
                    selectedHex = toHex;
                    selectedPiece = pieceToMove;
                    toHex.classList.add('selected');
                    
                    // é«˜äº®ä¸‹ä¸€æ¬¡å¯ç§»åŠ¨çš„æ ¼å­
                    highlightMovableHexes(toRow, toCol);
                    
                    return; // ç»§ç»­è¿ç»­ç§»åŠ¨ï¼Œä¸åˆ‡æ¢ç©å®¶
                }
            } else {
                // éæ–¹æ–¹æ£‹å­ï¼Œæ¸…é™¤é€‰ä¸­çŠ¶æ€
                clearHighlights();
                
                // ç§»åŠ¨æ£‹å­åŠŸèƒ½æˆåŠŸï¼Œå¢åŠ å›åˆæ•°
                playerTurns[currentPlayer]++;
                
                // æ£€æŸ¥å¯¹æ–¹ç›®æ ‡æ£‹å­æ˜¯å¦è¢«åŒ…å›´
                checkTargetSurrounded();
                
                // åˆ‡æ¢ç©å®¶
                currentPlayer = currentPlayer === 'player1' ? 'player2' : 'player1';
            }
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨é€‰ä¸­ç›®æ ‡æ£‹å­
            if (playerTurns[currentPlayer] === 2 && !hasPlacedTarget[currentPlayer]) {
                // ç¬¬ä¸‰å›åˆä¸”æœªæ”¾ç½®ç›®æ ‡æ£‹å­ï¼Œè‡ªåŠ¨é€‰ä¸­ç›®æ ‡æ£‹å­
                currentPieceType = 'target';
                
                // ç§»é™¤æ‰€æœ‰é€‰æ‹©å™¨çš„é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.piece-selector.selected').forEach(s => {
                    s.classList.remove('selected');
                });
                
                // è‡ªåŠ¨é€‰ä¸­å½“å‰ç©å®¶çš„ç›®æ ‡æ£‹å­é€‰æ‹©å™¨
                const targetSelectorId = `${currentPlayer}TargetLibrary`;
                const targetSelector = document.getElementById(targetSelectorId);
                if (targetSelector) {
                    targetSelector.classList.add('selected');
                    // è‡ªåŠ¨é€‰ä¸­åï¼Œé«˜äº®å¯æ”¾ç½®æ ¼å­
                    highlightPlaceableHexes();
                }
            } else {
                // æ­£å¸¸æ›´æ–°æ£‹å­é€‰æ‹©å™¨
                updatePieceSelector();
            }
        }
        
        // æ¸¸æˆç»“æŸå¤„ç†
        function gameOver(losingPlayer) {
            const winningPlayer = losingPlayer === 'player1' ? 'player2' : 'player1';
            const winningColor = winningPlayer === 'player1' ? 'çº¢æ–¹' : 'é»„æ–¹';
            
            // æ˜¾ç¤ºæ¸¸æˆç»“æŸè¦†ç›–å±‚
            const overlay = document.getElementById('gameOverOverlay');
            const text = document.getElementById('gameOverText');
            text.textContent = `${winningColor}èƒœåˆ©`;
            overlay.style.display = 'flex';
            
            // ç¦ç”¨æ‰€æœ‰äº¤äº’
            document.querySelector('.container').classList.add('game-over');
        }
        
        // æ”¾ç½®æ£‹å­åŠŸèƒ½
        function placePiece(hexElement) {
            // æ£€æŸ¥æ˜¯å¦é€‰ä¸­äº†æ£‹å­åº“ä¸­çš„æ£‹å­
            const hasSelectedPieceType = document.querySelector(`.piece-selector.selected`);
            if (!hasSelectedPieceType) {
                return; // æœªé€‰ä¸­æ£‹å­åº“ä¸­çš„æ£‹å­ï¼Œæ— æ³•æ”¾ç½®
            }
            
            const row = hexElement.dataset.row;
            const col = hexElement.dataset.col;
            const key = `${row}-${col}`;
            
            // æ£€æŸ¥ä½ç½®æ˜¯å¦å·²æœ‰æ£‹å­
            if (boardState.has(key)) {
                return; // ä½ç½®å·²è¢«å ç”¨ï¼Œæ— æ³•æ”¾ç½®
            }
            
            // æ£€æŸ¥å½“å‰ç©å®¶æ˜¯å¦è¿˜æœ‰å¯¹åº”ç±»å‹çš„æ£‹å­
            if (pieceCount[currentPlayer][currentPieceType] <= 0) {
                return; // è¯¥ç±»å‹æ£‹å­å·²ç”¨å®Œï¼Œæ— æ³•æ”¾ç½®
            }
            
            // ç¬¬ä¸‰å›åˆç‰¹æ®Šé€»è¾‘ï¼šå¦‚æœæ˜¯ç¬¬ä¸‰å›åˆä¸”æœªæ”¾ç½®ç›®æ ‡æ£‹å­ï¼Œåªèƒ½æ”¾ç½®ç›®æ ‡æ£‹å­
            if (playerTurns[currentPlayer] === 2 && !hasPlacedTarget[currentPlayer]) {
                if (currentPieceType !== 'target') {
                    return; // ç¬¬ä¸‰å›åˆå¿…é¡»æ”¾ç½®ç›®æ ‡æ£‹å­
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦ä¸æˆ‘æ–¹æ£‹å­ç›¸é‚»
            let hasAdjacentFriendlyPiece = false;
            // è·å–æ‰€æœ‰ç›¸é‚»æ ¼å­
            const adjacentCells = getAdjacentCells(row, col);
            for (const cell of adjacentCells) {
                const cellKey = `${cell.row}-${cell.col}`;
                const cellState = boardState.get(cellKey);
                if (cellState) {
                    // æ£€æŸ¥ç›¸é‚»æ ¼å­ä¸­æ˜¯å¦æœ‰æˆ‘æ–¹æ£‹å­
                    for (const piece of cellState.pieces) {
                        if (piece.player === currentPlayer) {
                            hasAdjacentFriendlyPiece = true;
                            break;
                        }
                    }
                    if (hasAdjacentFriendlyPiece) {
                        break;
                    }
                }
            }
            
            // ç¬¬ä¸€å›åˆæ”¾ç½®ç¬¬ä¸€ä¸ªæ£‹å­æ—¶ï¼Œä¸éœ€è¦ä¸æˆ‘æ–¹æ£‹å­ç›¸é‚»
            if (playerTurns[currentPlayer] === 0) {
                // ç¬¬ä¸€å›åˆå¯ä»¥æ”¾ç½®ä»»ä½•ç±»å‹çš„æ£‹å­
            } else if (!hasAdjacentFriendlyPiece) {
                return; // ä¸æ˜¯ç¬¬ä¸€å›åˆï¼Œå¿…é¡»ä¸æˆ‘æ–¹æ£‹å­ç›¸é‚»
            }
            
            // ä¿å­˜åŸå§‹çŠ¶æ€ï¼Œç”¨äºæ’¤é”€
            const originalHex = hexElement.cloneNode(true);
            const originalBoardState = new Map(boardState);
            const originalPieceCount = JSON.parse(JSON.stringify(pieceCount));
            
            // åˆ›å»ºæ£‹å­å…ƒç´ 
            const piece = document.createElement('div');
            piece.className = `piece ${currentPlayer} ${currentPieceType}`;
            
            // æ·»åŠ æ£‹å­åˆ°å…­è¾¹å½¢
            hexElement.appendChild(piece);
            
            // æ›´æ–°æ£‹ç›˜çŠ¶æ€
            boardState.set(key, { 
                pieces: [{ player: currentPlayer, type: currentPieceType }] 
            });
            
            // å¦‚æœæ”¾ç½®çš„æ˜¯ç›®æ ‡æ£‹å­ï¼Œæ›´æ–°ç›®æ ‡æ£‹å­æ”¾ç½®çŠ¶æ€
            if (currentPieceType === 'target') {
                hasPlacedTarget[currentPlayer] = true;
            }
            
            // å‡å°‘å½“å‰ç©å®¶å¯¹åº”ç±»å‹çš„æ£‹å­æ•°é‡
            pieceCount[currentPlayer][currentPieceType]--;
            
            // æ›´æ–°æ£‹å­åº“UI
            updatePieceLibrary();
            
            // æ£€æŸ¥è¿é€šæ€§
            if (!isConnected()) {
                // è¿é€šæ€§æ£€æŸ¥å¤±è´¥ï¼Œæ’¤é”€æ“ä½œ
                // æ¢å¤æ£‹ç›˜çŠ¶æ€
                boardState.clear();
                for (const [key, state] of originalBoardState) {
                    boardState.set(key, state);
                }
                
                // æ¢å¤æ£‹å­æ•°é‡
                Object.assign(pieceCount, originalPieceCount);
                
                // æ¢å¤DOM
                hexElement.innerHTML = originalHex.innerHTML;
                
                // æ›´æ–°æ£‹å­åº“UI
                updatePieceLibrary();
                
                return; // æ“ä½œæ’¤é”€ï¼Œä¸åˆ‡æ¢ç©å®¶
            }
            
            // æ”¾ç½®æ£‹å­åŠŸèƒ½æˆåŠŸï¼Œå¢åŠ å›åˆæ•°
            playerTurns[currentPlayer]++;
            
            // æ£€æŸ¥å¯¹æ–¹ç›®æ ‡æ£‹å­æ˜¯å¦è¢«åŒ…å›´
            checkTargetSurrounded();
            
            // åˆ‡æ¢ç©å®¶å‰æ¸…é™¤é€‰ä¸­çŠ¶æ€
            clearHighlights();
            
            // åˆ‡æ¢ç©å®¶
            currentPlayer = currentPlayer === 'player1' ? 'player2' : 'player1';
            
            // æ£€æŸ¥æ˜¯å¦éœ€è¦è‡ªåŠ¨é€‰ä¸­ç›®æ ‡æ£‹å­
            if (playerTurns[currentPlayer] === 2 && !hasPlacedTarget[currentPlayer]) {
                // ç¬¬ä¸‰å›åˆä¸”æœªæ”¾ç½®ç›®æ ‡æ£‹å­ï¼Œè‡ªåŠ¨é€‰ä¸­ç›®æ ‡æ£‹å­
                currentPieceType = 'target';
                
                // ç§»é™¤æ‰€æœ‰é€‰æ‹©å™¨çš„é€‰ä¸­çŠ¶æ€
                document.querySelectorAll('.piece-selector.selected').forEach(s => {
                    s.classList.remove('selected');
                });
                
                // è‡ªåŠ¨é€‰ä¸­å½“å‰ç©å®¶çš„ç›®æ ‡æ£‹å­é€‰æ‹©å™¨
                const targetSelectorId = `${currentPlayer}TargetLibrary`;
                const targetSelector = document.getElementById(targetSelectorId);
                if (targetSelector) {
                    targetSelector.classList.add('selected');
                }
            } else {
                // æ­£å¸¸æ›´æ–°æ£‹å­é€‰æ‹©å™¨
                updatePieceSelector();
            }
        }
        
        // åˆå§‹åŒ–æ£‹å­åº“UI
        updatePieceLibrary();
        
        // æ›´æ–°æ£‹å­é€‰æ‹©å™¨UI
        function updatePieceSelector() {
            // ç§»é™¤æ‰€æœ‰é€‰æ‹©å™¨çš„é€‰ä¸­çŠ¶æ€
            document.querySelectorAll('.piece-selector').forEach(selector => {
                selector.classList.remove('selected');
            });
            
            // åªæœ‰åœ¨ç©å®¶æ‰‹åŠ¨ç‚¹å‡»é€‰æ‹©æ—¶æ‰æ·»åŠ é€‰ä¸­çŠ¶æ€ï¼Œåˆ‡æ¢ç©å®¶æ—¶ä¸è‡ªåŠ¨é€‰ä¸­
        }
        
        // åˆå§‹åŒ–æ£‹å­é€‰æ‹©å™¨ï¼Œä¸è‡ªåŠ¨é€‰ä¸­ä»»ä½•æ£‹å­ç±»å‹
        updatePieceSelector();
        
        // æ•™ç¨‹ç›¸å…³å‡½æ•°
        function startTutorial() {
            // éšè—æ•™ç¨‹ä¸»ç•Œé¢
            document.getElementById('tutorialOverlay').style.display = 'none';
            // æ˜¾ç¤ºæ–°æ‰‹æç¤ºç•Œé¢
            document.getElementById('newbieOverlay').style.display = 'flex';
            // æ ‡è®°ä¸ºå·²æŸ¥çœ‹æ•™ç¨‹
            localStorage.setItem('hasSeenTutorial', 'true');
        }
        
        function skipTutorial() {
            // è·³è¿‡æ•™ç¨‹ï¼Œç›´æ¥éšè—æ•™ç¨‹ç•Œé¢
            document.getElementById('tutorialOverlay').style.display = 'none';
            // æ ‡è®°ä¸ºå·²æŸ¥çœ‹æ•™ç¨‹
            localStorage.setItem('hasSeenTutorial', 'true');
        }
        
        function closeNewbieHint() {
            // å…³é—­æ–°æ‰‹æç¤ºç•Œé¢ï¼Œè¿›å…¥æ¸¸æˆ
            document.getElementById('newbieOverlay').style.display = 'none';
        }
        
        function restartGame() {
            // æ ‡è®°ä¸ºå·²æŸ¥çœ‹æ•™ç¨‹ï¼Œé¿å…å†æ¬¡æ˜¾ç¤º
            localStorage.setItem('hasSeenTutorial', 'true');
            // é‡æ–°åŠ è½½é¡µé¢
            location.reload();
        }
        
        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥æ˜¯å¦æ˜¾ç¤ºæ•™ç¨‹ç•Œé¢
        window.addEventListener('DOMContentLoaded', () => {
            const hasSeenTutorial = localStorage.getItem('hasSeenTutorial');
            if (!hasSeenTutorial) {
                document.getElementById('tutorialOverlay').style.display = 'flex';
            }
        });
        
        // é«˜äº®å¯æ”¾ç½®æ£‹å­çš„æ ¼å­
        function highlightPlaceableHexes() {
            // æ¸…é™¤ä¹‹å‰çš„é«˜äº®
            document.querySelectorAll('.hex.movable').forEach(hex => {
                hex.classList.remove('movable');
                hex.classList.remove('invalid');
            });
            
            // éå†æ‰€æœ‰å…­è¾¹å½¢æ ¼å­
            document.querySelectorAll('.hex').forEach(hex => {
                const row = hex.dataset.row;
                const col = hex.dataset.col;
                const key = `${row}-${col}`;
                
                // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ”¾ç½®æ£‹å­
                if (!boardState.has(key)) {
                    // æ£€æŸ¥æ˜¯å¦ä¸æˆ‘æ–¹æ£‹å­ç›¸é‚»
                    let hasAdjacentFriendlyPiece = false;
                    // è·å–æ‰€æœ‰ç›¸é‚»æ ¼å­
                    const adjacentCells = getAdjacentCells(row, col);
                    for (const cell of adjacentCells) {
                        const cellKey = `${cell.row}-${cell.col}`;
                        const cellState = boardState.get(cellKey);
                        if (cellState) {
                            // æ£€æŸ¥ç›¸é‚»æ ¼å­ä¸­æ˜¯å¦æœ‰æˆ‘æ–¹æ£‹å­
                            for (const piece of cellState.pieces) {
                                if (piece.player === currentPlayer) {
                                    hasAdjacentFriendlyPiece = true;
                                    break;
                                }
                            }
                            if (hasAdjacentFriendlyPiece) {
                                break;
                            }
                        }
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ”¾ç½®ï¼ˆç¬¬ä¸€å›åˆæˆ–ä¸æˆ‘æ–¹æ£‹å­ç›¸é‚»ï¼‰
                    const canPlace = (playerTurns[currentPlayer] === 0) || hasAdjacentFriendlyPiece;
                    
                    if (canPlace) {
                        // æ£€æŸ¥è¿é€šæ€§ï¼ˆæ¨¡æ‹Ÿæ”¾ç½®ï¼‰
                        // åˆ›å»ºä¸´æ—¶çŠ¶æ€
                        const tempBoardState = new Map();
                        for (const [k, state] of boardState) {
                            tempBoardState.set(k, { pieces: [...state.pieces] });
                        }
                        
                        // æ¨¡æ‹Ÿæ”¾ç½®æ£‹å­
                        tempBoardState.set(key, { pieces: [{ player: currentPlayer, type: currentPieceType }] });
                        
                        // ä¿å­˜åŸå§‹çŠ¶æ€
                        const originalBoardState = new Map(boardState);
                        
                        // ä¸´æ—¶æ›¿æ¢æ£‹ç›˜çŠ¶æ€
                        boardState.clear();
                        for (const [k, state] of tempBoardState) {
                            boardState.set(k, state);
                        }
                        
                        // æ£€æŸ¥è¿é€šæ€§
                        const isConnectedAfterPlacement = isConnected();
                        
                        // æ¢å¤åŸå§‹çŠ¶æ€
                        boardState.clear();
                        for (const [k, state] of originalBoardState) {
                            boardState.set(k, state);
                        }
                        
                        if (isConnectedAfterPlacement) {
                            hex.classList.add('movable');
                        }
                    }
                }
            });
        }
        
        // æ£‹å­é€‰æ‹©å™¨ç‚¹å‡»äº‹ä»¶
        document.querySelectorAll('.piece-selector').forEach(selector => {
            selector.addEventListener('click', () => {
                // è·å–æ£‹å­ç±»å‹
                const pieceType = selector.dataset.pieceType;
                
                // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰ç©å®¶çš„æ£‹å­åº“
            if (selector.id.startsWith(currentPlayer)) {
                // ç¬¬ä¸‰å›åˆç‰¹æ®Šé€»è¾‘ï¼šå¦‚æœæ˜¯ç¬¬ä¸‰å›åˆä¸”æœªæ”¾ç½®ç›®æ ‡æ£‹å­ï¼Œåªèƒ½é€‰æ‹©ç›®æ ‡æ£‹å­
                if (playerTurns[currentPlayer] === 2 && !hasPlacedTarget[currentPlayer]) {
                    if (pieceType !== 'target') {
                        return; // ç¬¬ä¸‰å›åˆå¿…é¡»é€‰æ‹©ç›®æ ‡æ£‹å­ç±»å‹
                    }
                }
                    
                    // æ›´æ–°å½“å‰æ£‹å­ç±»å‹
                    currentPieceType = pieceType;
                    
                    // ç§»é™¤æ‰€æœ‰é€‰æ‹©å™¨çš„é€‰ä¸­çŠ¶æ€
                    document.querySelectorAll('.piece-selector.selected').forEach(s => {
                        s.classList.remove('selected');
                    });
                    
                    // ä¸ºå½“å‰é€‰ä¸­çš„é€‰æ‹©å™¨æ·»åŠ é€‰ä¸­çŠ¶æ€
                    selector.classList.add('selected');
                    
                    // é«˜äº®å¯æ”¾ç½®æ£‹å­çš„æ ¼å­
                    highlightPlaceableHexes();
                }
            });
        });
        
        // ä¸ºæ‰€æœ‰å…­è¾¹å½¢æ·»åŠ å·¦é”®ç‚¹å‡»äº‹ä»¶ï¼ˆé€‰æ‹©/ç§»åŠ¨/æ”¾ç½®æ£‹å­ï¼‰
        document.querySelectorAll('.hex').forEach(hex => {
            hex.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                
                // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†å¯ç§»åŠ¨æ ¼å­
                if (hex.classList.contains('movable') && selectedHex) {
                    // æ£€æŸ¥æ˜¯å¦æ˜¯æ— æ•ˆç§»åŠ¨
                    if (!hex.classList.contains('invalid')) {
                        // ç§»åŠ¨æ£‹å­
                        movePiece(selectedHex, hex);
                    }
                } else {
                    // æ£€æŸ¥æ˜¯å¦å·²ç»é€‰ä¸­äº†æ£‹å­
                    if (selectedHex && selectedPiece) {
                        // æ£€æŸ¥æ˜¯å¦æ˜¯æ–¹æ–¹æ£‹å­æ­£åœ¨è¿ç»­ç§»åŠ¨
                        const isSquarePiece = selectedPiece.classList.contains('square');
                        if (isSquarePiece && squareMoveState.inProgress) {
                            // æ–¹æ–¹æ£‹å­æ­£åœ¨è¿ç»­ç§»åŠ¨ï¼Œä¸å–æ¶ˆé€‰ä¸­
                        } else {
                            // å–æ¶ˆé€‰ä¸­çŠ¶æ€
                            clearHighlights();
                        }
                    }
                    
                    // æ£€æŸ¥æ˜¯å¦æœ‰æ£‹å­å¯ä»¥é€‰æ‹©
                    const pieces = hex.querySelectorAll('.piece');
                    if (pieces.length > 0) {
                        // é€‰æ‹©æ£‹å­ï¼ˆselectPieceå‡½æ•°ä¼šå¤„ç†é€‰æ‹©æœ€ä¸Šé¢çš„æ£‹å­ï¼‰
                        selectPiece(hex);
                    } else {
                        // æ£€æŸ¥æ˜¯å¦å¯ä»¥æ”¾ç½®æ£‹å­
                        const hasSelectedPieceType = document.querySelector('.piece-selector.selected');
                        if (hasSelectedPieceType) {
                            // å°è¯•æ”¾ç½®æ£‹å­
                            placePiece(hex);
                            // å¦‚æœæ”¾ç½®å¤±è´¥ï¼ˆplacePieceå‡½æ•°ä¼šæ£€æŸ¥æ˜¯å¦å¯ä»¥æ”¾ç½®ï¼‰ï¼Œå–æ¶ˆæ£‹å­é€‰æ‹©
                            // æ£€æŸ¥æ˜¯å¦ä»ç„¶æœ‰é€‰ä¸­çš„æ£‹å­ç±»å‹
                            const stillSelected = document.querySelector('.piece-selector.selected');
                            if (stillSelected && !boardState.has(hex.dataset.row + '-' + hex.dataset.col)) {
                                clearHighlights();
                            }
                        } else {
                            // æ²¡æœ‰é€‰ä¸­æ£‹å­ç±»å‹ï¼Œæ¸…é™¤é«˜äº®
                            clearHighlights();
                        }
                    }
                }
            });
        });
        
        // ä¸ºæ‰€æœ‰å…­è¾¹å½¢æ·»åŠ å³é”®äº‹ä»¶ï¼ˆä»…é˜»æ­¢é»˜è®¤èœå•ï¼‰
        document.querySelectorAll('.hex').forEach(hex => {
            hex.addEventListener('contextmenu', (e) => {
                e.preventDefault(); // é˜»æ­¢é»˜è®¤å³é”®èœå•
                e.stopPropagation(); // é˜»æ­¢äº‹ä»¶å†’æ³¡åˆ°boardå…ƒç´ 
            });
        });
        
        // ç‚¹å‡»æ£‹ç›˜ç©ºç™½åŒºåŸŸæ¸…é™¤é€‰ä¸­çŠ¶æ€ï¼Œä½†æ–¹æ–¹æ£‹å­è¿ç»­ç§»åŠ¨æ—¶é™¤å¤–
        board.addEventListener('click', () => {
            // å¦‚æœæ–¹æ–¹æ£‹å­æ­£åœ¨è¿ç»­ç§»åŠ¨ï¼Œä¸æ¸…é™¤é€‰ä¸­çŠ¶æ€
            if (!squareMoveState.inProgress) {
                clearHighlights();
            }
        });
        
        // æ‹–åŠ¨åŠŸèƒ½
        let isDragging = false;
        let startX, startY;
        let boardX = -50; // åˆå§‹ç™¾åˆ†æ¯”ä½ç½®
        let boardY = -50;
        let offsetX = 0; // åƒç´ åç§»é‡
        let offsetY = 0;
        
        // æ›´æ–°æ£‹ç›˜ä½ç½®
        function updateBoardPosition() {
            board.style.transform = `translate(${boardX}%, ${boardY}%) translate(${offsetX}px, ${offsetY}px)`;
        }
        
        // é¼ æ ‡æŒ‰ä¸‹äº‹ä»¶
        board.addEventListener('mousedown', (e) => {
            // åªå“åº”å·¦é”®æ‹–åŠ¨
            if (e.button === 0) {
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
            }
        });
        
        // é¼ æ ‡ç§»åŠ¨äº‹ä»¶
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            
            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;
            
            // ç›´æ¥ä½¿ç”¨é¼ æ ‡ç§»åŠ¨è·ç¦»ä½œä¸ºæ£‹ç›˜åç§»
            offsetX += deltaX;
            offsetY += deltaY;
            
            updateBoardPosition();
            
            startX = e.clientX;
            startY = e.clientY;
        });
        
        // é¼ æ ‡é‡Šæ”¾äº‹ä»¶
        document.addEventListener('mouseup', () => {
            isDragging = false;
        });
        
        // é¼ æ ‡ç§»å‡ºçª—å£äº‹ä»¶
        document.addEventListener('mouseleave', () => {
            isDragging = false;
        });
        
        // é˜²æ­¢boardå…ƒç´ ä¸Šçš„å³é”®èœå•
        board.addEventListener('contextmenu', (e) => {
            e.preventDefault();
        });
        
        // ä¸ºæ•™ç¨‹æŒ‰é’®æ·»åŠ ç‚¹å‡»äº‹ä»¶
        document.getElementById('tutorialButton').addEventListener('click', () => {
            // æ˜¾ç¤ºæ–°æ‰‹æç¤ºç•Œé¢
            document.getElementById('newbieOverlay').style.display = 'flex';
        });
    </script>
</body>
</html>